<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Virksomhedsportal</title>
<style>
html,body {
  height:100%; margin:0; font-family:"Segoe UI",Arial,sans-serif;
  display:flex; justify-content:center; align-items:center;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:#f8fafc;
}
.container {
  background:#1e293b; padding:2rem; border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,0.5);
  width:480px; max-width:95%; display:flex; flex-direction:column;
  align-items:center; position:relative;
}
.hidden { display:none; }
input,button {
  padding:0.7rem; font-size:1rem; border-radius:8px;
  border:none; outline:none;
}
input { background:#334155; color:white; margin:0.3rem 0; width:100%; box-sizing:border-box; }
button { background:#2563eb; color:white; cursor:pointer; font-weight:600; margin:0.3rem 0; transition:0.2s; }
button:hover { background:#1d4ed8; transform:translateY(-2px); box-shadow:0 4px 12px rgba(37,99,235,0.4); }
.logout-btn { position:absolute; top:10px; right:10px; background:#ef4444; font-size:0.8rem; padding:0.3rem 0.6rem; border-radius:6px; }
.logout-btn:hover { background:#dc2626; }
#timer { position:absolute; top:10px; left:10px; font-size:0.8rem; background:rgba(0,0,0,0.4); padding:0.2rem 0.5rem; border-radius:6px; }

/* Scrollområde kun for virksomhedslisten */
#companies { max-height:350px; overflow-y:auto; width:100%; margin-top:0.5rem; }
#companies::-webkit-scrollbar { width:8px; }
#companies::-webkit-scrollbar-thumb { background:#475569; border-radius:4px; }

.company { background:#334155; border-radius:10px; padding:0.75rem; margin:0.5rem 0; }
.company-top { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
.level { font-weight:bold; color:#38bdf8; }
.emoji-btn { background:none; border:none; font-size:1rem; cursor:pointer; margin:0 2px; }
.emoji-btn:hover { transform:scale(1.2); }
.input-row { display:flex; justify-content:space-between; align-items:center; margin-top:5px; }
.input-row input { flex:1; margin-right:5px; }
.input-row button { flex:0 0 90px; }
#searchInput { background:#334155; color:white; padding:0.6rem; border-radius:8px; border:none; margin-bottom:0.5rem; width:100%; }
.flex-top { display:flex; justify-content:space-between; align-items:center; width:100%; }
</style>
<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getFirestore, doc, collection, getDocs, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCsMKaGW_8LN3BTTtmmslSJdGZngzFJcQw",
    authDomain: "legacydgrevision.firebaseapp.com",
    projectId: "legacydgrevision",
    storageBucket: "legacydgrevision.firebasestorage.app",
    messagingSenderId: "1091128393651",
    appId: "1:1091128393651:web:59e6a8644d40f8576b15c6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
</script>
</head>
<body>
<div id="timer"></div>
<div class="container">
  <button id="logoutBtn" class="logout-btn hidden">Log ud</button>

  <!-- Login -->
  <div id="loginScreen">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Brugernavn">
    <input type="password" id="password" placeholder="Adgangskode">
    <button id="loginBtn">Login</button>
    <p id="loginError" class="hidden">Forkert brugernavn eller kode!</p>
  </div>

  <!-- Menu -->
  <div id="mainMenu" class="hidden">
    <h2>Virksomhedsportal</h2>
    <button id="createBtn">Opret ny virksomhed</button>
    <button id="listBtn">Eksisterende virksomheder</button>
    <button id="adminBtn" class="hidden">Admin Kontrolpanel</button>
  </div>

  <!-- Opret -->
  <div id="createCompany" class="hidden">
    <h2>Opret virksomhed</h2>
    <input id="companyName" placeholder="Virksomhedsnavn">
    <input id="cvr" placeholder="CVR-nummer">
    <input id="owner" placeholder="Ejerens navn">
    <div class="flex-top">
      <button id="createCompanyBtn">Opret</button>
      <button id="backFromCreateBtn">Tilbage</button>
    </div>
  </div>

  <!-- Liste -->
  <div id="companyList" class="hidden">
    <h2>Eksisterende virksomheder</h2>
    <input id="searchInput" placeholder="Søg efter navn, ejer eller CVR..." oninput="renderCompanies()">
    <div class="flex-top">
      <button id="backFromListBtn">Tilbage</button>
      <button id="refreshListBtn">Refresh</button>
    </div>
    <div id="companies"></div>
  </div>

  <!-- Admin -->
  <div id="adminPanel" class="hidden">
    <h2>Admin Kontrolpanel</h2>
    <input type="password" id="newAdminPassword" placeholder="Nyt admin kodeord">
    <button id="changeAdminBtn">Skift Admin</button>
    <input type="password" id="newUserPassword" placeholder="Nyt user kodeord">
    <button id="changeUserBtn">Skift User</button>
    <button id="adminBackBtn">Tilbage</button>
  </div>
</div>

<script type="module">
import { getFirestore, collection, addDoc, setDoc, doc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
const db = getFirestore();

let currentRole = "";
let currentUser = "";
const LEVELS = [{name:"Bronze (20%)"},{name:"Sølv (17,5%)"},{name:"Guld (15%)"},{name:"Platin (10%)"}];
let companies = [];

// --- LOGIN ---
async function login(){
  const user=document.getElementById("username").value.trim();
  const pass=document.getElementById("password").value.trim();
  const docRef = doc(db,"appState","state");
  const snap = await getDoc(docRef);
  if(!snap.exists()){ alert("App state mangler i Firebase"); return; }
  const data = snap.data();
  if(data.admins.includes(user) && pass==="admin"){ currentRole="admin"; currentUser=user; showMain(true); }
  else if(data.user===user && pass==="user"){ currentRole="user"; currentUser=user; showMain(false); }
  else document.getElementById("loginError").classList.remove("hidden");
}

// --- SHOW/HIDE ---
function logout(){
  currentRole=""; currentUser="";
  document.getElementById("loginScreen").classList.remove("hidden");
  hideAll(["mainMenu","createCompany","companyList","adminPanel"]);
  document.getElementById("logoutBtn").classList.add("hidden");
}
function showMain(isAdmin){
  hideAll(["loginScreen","createCompany","companyList","adminPanel"]);
  document.getElementById("mainMenu").classList.remove("hidden");
  document.getElementById("logoutBtn").classList.remove("hidden");
  document.getElementById("adminBtn").classList.toggle("hidden",!isAdmin);
  document.getElementById("loginError").classList.add("hidden");
}
function hideAll(arr){ arr.forEach(id=>document.getElementById(id).classList.add("hidden")); }
function showSection(id){ hideAll(["mainMenu","createCompany","companyList","adminPanel"]); document.getElementById(id).classList.remove("hidden"); }

// --- COMPANIES ---
const companiesCol = collection(db,"companies");
onSnapshot(companiesCol,(snap)=>{
  companies=[];
  snap.forEach(doc=>companies.push({id:doc.id,...doc.data()}));
  renderCompanies();
});

function renderCompanies(){
  const cont=document.getElementById("companies");
  const q=document.getElementById("searchInput").value.toLowerCase();
  cont.innerHTML="";
  companies.forEach((c,i)=>{
    if(q && !(c.name.toLowerCase().includes(q)||c.owner.toLowerCase().includes(q)||c.cvr.toLowerCase().includes(q))) return;
    const div=document.createElement("div");
    div.className="company";
    const controls=currentRole==="admin"?`
      <button class="emoji-btn" onclick="changeLevel('${c.id}',1)">⬆️</button>
      <button class="emoji-btn" onclick="changeLevel('${c.id}',-1)">⬇️</button>
      <button style='background:#ef4444' onclick='delCompany("${c.id}")'>Slet</button>`:"";
    div.innerHTML=`<div class="company-top">
      <div><strong>${c.name}</strong><br>CVR: ${c.cvr}<br>Ejer: ${c.owner}<br>Indtjening: ${c.income} DKK</div>
      <div><span class="level">${getLevel(c)}</span>${controls}</div>
    </div>
    <div class="input-row"><input type="number" id="income${c.id}" placeholder="Indtjening (DKK)">
    <button onclick="addIncome('${c.id}')">Tilføj</button></div>`;
    cont.appendChild(div);
  });
}

function getLevel(c){
  if(c.manualLevel!=null) return LEVELS[c.manualLevel].name;
  const inc=c.income||0;
  if(inc<100000) return LEVELS[0].name;
  if(inc<250000) return LEVELS[1].name;
  if(inc<500000) return LEVELS[2].name;
  return LEVELS[3].name;
}

window.addIncome = async (id)=>{
  const val=parseFloat(document.getElementById(`income${id}`).value);
  if(isNaN(val)||val<=0) return;
  const c = companies.find(x=>x.id===id);
  await updateDoc(doc(db,"companies",id),{income:(c.income||0)+val, manualLevel:null});
  document.getElementById(`income${id}`).value="";
};
window.changeLevel = async (id,d)=>{
  if(currentRole!=="admin") return;
  const c = companies.find(x=>x.id===id);
  let lvl = (c.manualLevel||0)+d;
  if(lvl<0) lvl=0;
  if(lvl>3) lvl=3;
  await updateDoc(doc(db,"companies",id),{manualLevel:lvl});
};
window.delCompany = async (id)=>{
  if(currentRole!=="admin") return;
  await deleteDoc(doc(db,"companies",id));
};

// --- CREATE COMPANY ---
document.getElementById("createCompanyBtn").onclick=async ()=>{
  const n=document.getElementById("companyName").value.trim();
  const c=document.getElementById("cvr").value.trim();
  const o=document.getElementById("owner").value.trim();
  if(!n||!c||!o) return;
  await addDoc(collection(db,"companies"),{name:n,cvr:c,owner:o,income:0,manualLevel:null});
  document.getElementById("companyName").value="";
  document.getElementById("cvr").value="";
  document.getElementById("owner").value="";
};

// --- TIMER & RESET ---
function resetIfMonday(){
  const t=new Date(), last=new Date(localStorage.getItem("lastReset")||0);
  if(t.getDay()===1 && t.toDateString()!==last.toDateString()){
    companies.forEach(async c=>{
      await updateDoc(doc(db,"companies",c.id),{income:0,manualLevel:null});
    });
    localStorage.setItem("lastReset",t.toDateString());
  }
}
function updateTimer(){
  const now=new Date();
  const next=new Date(now);
  next.setDate(now.getDate()+((8-now.getDay())%7));
  next.setHours(0,1,0,0);
  const diff=next-now;
  const d=Math.floor(diff/86400000);
  const h=Math.floor(diff/3600000)%24;
  const m=Math.floor(diff/60000)%60;
  document.getElementById("timer").textContent=`Til næste mandag: ${d}d ${h}h ${m}m`;
}
setInterval(updateTimer,60000); updateTimer(); resetIfMonday();

// --- NAVIGATION ---
document.getElementById("loginBtn").onclick=login;
document.getElementById("logoutBtn").onclick=logout;
document.getElementById("createBtn").onclick=()=>showSection("createCompany");
document.getElementById("listBtn").onclick=()=>showSection("companyList");
document.getElementById("backFromListBtn").onclick=()=>showSection("mainMenu");
document.getElementById("refreshListBtn").onclick=renderCompanies;
document.getElementById("backFromCreateBtn").onclick=()=>showSection("mainMenu");
document.getElementById("adminBtn").onclick=()=>showSection("adminPanel");
document.getElementById("adminBackBtn").onclick=()=>showSection("mainMenu");
</script>
</body>
</html>
