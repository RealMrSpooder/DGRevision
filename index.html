<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Virksomhedsportal</title>
<style>
html,body { height:100%; margin:0; font-family:"Segoe UI",Arial,sans-serif; display:flex; justify-content:center; align-items:center; background:linear-gradient(135deg,#0f172a,#1e293b); color:#f8fafc; }
.container { background:#1e293b; padding:2rem; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.5); width:480px; max-width:95%; display:flex; flex-direction:column; align-items:center; position:relative; }
.hidden { display:none; }
input,button { padding:0.7rem; font-size:1rem; border-radius:8px; border:none; outline:none; }
input { background:#334155; color:white; margin:0.3rem 0; width:100%; box-sizing:border-box; }
button { background:#2563eb; color:white; cursor:pointer; font-weight:600; margin:0.3rem 0; transition:0.2s; }
button:hover { background:#1d4ed8; transform:translateY(-2px); box-shadow:0 4px 12px rgba(37,99,235,0.4); }
.logout-btn { position:absolute; top:10px; right:10px; background:#ef4444; font-size:0.8rem; padding:0.3rem 0.6rem; border-radius:6px; }
.logout-btn:hover { background:#dc2626; }
#timer { position:absolute; top:10px; left:10px; font-size:0.8rem; background:rgba(0,0,0,0.4); padding:0.2rem 0.5rem; border-radius:6px; }
#companies { max-height:350px; overflow-y:auto; width:100%; margin-top:0.5rem; }
#companies::-webkit-scrollbar { width:8px; }
#companies::-webkit-scrollbar-thumb { background:#475569; border-radius:4px; }
.company { background:#334155; border-radius:10px; padding:0.75rem; margin:0.5rem 0; }
.company-top { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
.level { font-weight:bold; color:#38bdf8; }
.emoji-btn { background:none; border:none; font-size:1rem; cursor:pointer; margin:0 2px; }
.emoji-btn:hover { transform:scale(1.2); }
.input-row { display:flex; justify-content:space-between; align-items:center; margin-top:5px; }
.input-row input { flex:1; margin-right:5px; }
.input-row button { flex:0 0 90px; }
#searchInput { background:#334155; color:white; padding:0.6rem; border-radius:8px; border:none; margin-bottom:0.5rem; width:100%; }
.flex-top { display:flex; justify-content:space-between; align-items:center; width:100%; }
</style>
</head>
<body>
<div id="timer"></div>
<div class="container">
  <button id="logoutBtn" class="logout-btn hidden">Log ud</button>

  <!-- Login -->
  <div id="loginScreen">
    <h2>Login</h2>
    <input type="password" id="password" placeholder="Indtast adgangskode">
    <button id="loginBtn">Login</button>
    <p id="loginError" class="hidden">Forkert kode!</p>
  </div>

  <!-- Menu -->
  <div id="mainMenu" class="hidden">
    <h2>Virksomhedsportal</h2>
    <button id="createBtn">Opret ny virksomhed</button>
    <button id="listBtn">Eksisterende virksomheder</button>
    <button id="adminBtn" class="hidden">Admin Kontrolpanel</button>
  </div>

  <!-- Opret -->
  <div id="createCompany" class="hidden">
    <h2>Opret virksomhed</h2>
    <input id="companyName" placeholder="Virksomhedsnavn">
    <input id="cvr" placeholder="CVR-nummer">
    <input id="owner" placeholder="Ejerens navn">
    <div class="flex-top">
      <button id="createCompanyBtn">Opret</button>
      <button id="backFromCreateBtn">Tilbage</button>
    </div>
  </div>

  <!-- Liste -->
  <div id="companyList" class="hidden">
    <h2>Eksisterende virksomheder</h2>
    <input id="searchInput" placeholder="Søg efter navn, ejer eller CVR..." oninput="renderCompanies()">
    <div class="flex-top">
      <button id="backFromListBtn">Tilbage</button>
      <button id="refreshListBtn">Refresh</button>
    </div>
    <div id="companies"></div>
  </div>

  <!-- Admin -->
  <div id="adminPanel" class="hidden">
    <h2>Admin Kontrolpanel</h2>
    <input type="password" id="newAdminPassword" placeholder="Nyt admin kodeord">
    <button id="changeAdminBtn">Skift Admin</button>
    <input type="password" id="newUserPassword" placeholder="Nyt user kodeord">
    <button id="changeUserBtn">Skift User</button>
    <button id="adminBackBtn">Tilbage</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCsMKaGW_8LN3BTTtmmslSJdGZngzFJcQw",
  authDomain: "legacydgrevision.firebaseapp.com",
  projectId: "legacydgrevision",
  storageBucket: "legacydgrevision.appspot.com",
  messagingSenderId: "1234567890",
  appId: "1:1234567890:web:abcdef123456"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- GLOBALS ---
let currentRole = "";
const LEVELS = [{name:"Bronze (20%)"},{name:"Sølv (17,5%)"},{name:"Guld (15%)"},{name:"Platin (10%)"}];
const companiesCol = collection(db, "companies");

// --- LOGIN ---
async function login(){
  const pass = document.getElementById("password").value.trim();
  const err = document.getElementById("loginError");
  const stateDoc = doc(db, "appState", "state");
  const stateSnap = await getDoc(stateDoc);
  const data = stateSnap.exists() ? stateSnap.data() : { admins: ["admin"], user: "user" };
  
  if(data.admins.includes(pass)){ currentRole="admin"; showMain(true); err.classList.add("hidden"); }
  else if(pass === data.user){ currentRole="user"; showMain(false); err.classList.add("hidden"); }
  else err.classList.remove("hidden");
}

function logout(){
  currentRole="";
  document.getElementById("loginScreen").classList.remove("hidden");
  hideAll(["mainMenu","createCompany","companyList","adminPanel"]);
  document.getElementById("logoutBtn").classList.add("hidden");
  document.getElementById("password").value="";
}

function showMain(isAdmin){
  hideAll(["loginScreen","createCompany","companyList","adminPanel"]);
  document.getElementById("mainMenu").classList.remove("hidden");
  document.getElementById("logoutBtn").classList.remove("hidden");
  document.getElementById("adminBtn").classList.toggle("hidden", !isAdmin);
}

function hideAll(arr){ arr.forEach(id=>document.getElementById(id).classList.add("hidden")); }
function showSection(id){ hideAll(["mainMenu","createCompany","companyList","adminPanel"]); document.getElementById(id).classList.remove("hidden"); }

// --- COMPANIES ---
let companies = [];

// Lyt til real-time opdateringer
onSnapshot(companiesCol, snapshot=>{
  companies = snapshot.docs.map(doc=>({ id: doc.id, ...doc.data() }));
  renderCompanies();
});

function renderCompanies(){
  const cont = document.getElementById("companies");
  const q = document.getElementById("searchInput").value.toLowerCase();
  cont.innerHTML = "";
  companies.forEach((c,i)=>{
    if(q && !(c.name.toLowerCase().includes(q)||c.owner.toLowerCase().includes(q)||c.cvr.toLowerCase().includes(q))) return;
    const div = document.createElement("div");
    div.className = "company";
    
    const controls = currentRole==="admin"?`
      <button class="emoji-btn" onclick="changeLevel('${c.id}',1)">⬆️</button>
      <button class="emoji-btn" onclick="changeLevel('${c.id}',-1)">⬇️</button>
      <button style='background:#ef4444' onclick="del('${c.id}')">Slet</button>` : "";
    
    div.innerHTML = `
      <div class="company-top">
        <div><strong>${c.name}</strong><br>CVR: ${c.cvr}<br>Ejer: ${c.owner}<br>Indtjening: ${c.income} DKK</div>
        <div><span class="level">${getLevel(c)}</span>${controls}</div>
      </div>
      <div class="input-row"><input type="number" id="income${c.id}" placeholder="Indtjening (DKK)">
      <button onclick="addIncome('${c.id}')">Tilføj</button></div>
    `;
    cont.appendChild(div);
  });
}

function getLevel(c){
  if(c.manualLevel!=null) return LEVELS[c.manualLevel].name;
  const inc = c.income;
  if(inc<100000) return LEVELS[0].name;
  if(inc<250000) return LEVELS[1].name;
  if(inc<500000) return LEVELS[2].name;
  return LEVELS[3].name;
}

async function addIncome(id){
  const val = parseFloat(document.getElementById(`income${id}`).value);
  if(isNaN(val) || val <= 0) return;
  const c = companies.find(c=>c.id===id);
  const ref = doc(db,"companies",id);
  await updateDoc(ref,{ income: c.income+val, manualLevel: null });
}

async function changeLevel(id,d){
  if(currentRole!=="admin") return;
  const c = companies.find(c=>c.id===id);
  const newLevel = Math.max(0, Math.min(3, (c.manualLevel||0)+d));
  await updateDoc(doc(db,"companies",id),{ manualLevel: newLevel });
}

async function del(id){
  if(currentRole!=="admin") return;
  await deleteDoc(doc(db,"companies",id));
}

// --- EVENTS ---
document.getElementById("loginBtn").onclick = login;
document.getElementById("logoutBtn").onclick = logout;
document.getElementById("createBtn").onclick = ()=>showSection("createCompany");
document.getElementById("listBtn").onclick = ()=>showSection("companyList");
document.getElementById("backFromListBtn").onclick = ()=>showSection("mainMenu");
document.getElementById("refreshListBtn").onclick = renderCompanies;
document.getElementById("backFromCreateBtn").onclick = ()=>showSection("mainMenu");
document.getElementById("adminBtn").onclick = ()=>showSection("adminPanel");
document.getElementById("adminBackBtn").onclick = ()=>showSection("mainMenu");

document.getElementById("createCompanyBtn").onclick = async ()=>{
  const n = document.getElementById("companyName").value.trim();
  const cvr = document.getElementById("cvr").value.trim();
  const owner = document.getElementById("owner").value.trim();
  if(!n||!cvr||!owner) return;
  await addDoc(companiesCol,{ name:n, cvr:cvr, owner:owner, income:0, manualLevel:null });
  document.getElementById("companyName").value = "";
  document.getElementById("cvr").value = "";
  document.getElementById("owner").value = "";
};

document.getElementById("changeAdminBtn").onclick = async ()=>{
  const val = document.getElementById("newAdminPassword").value.trim();
  if(!val) return;
  const stateDoc = doc(db,"appState","state");
  const snap = await getDoc(stateDoc);
  let data = snap.exists()? snap.data() : { admins: [], user: "user" };
  if(!data.admins.includes(val)) data.admins.push(val);
  await setDoc(stateDoc, data);
};

document.getElementById("changeUserBtn").onclick = async ()=>{
  const val = document.getElementById("newUserPassword").value.trim();
  if(!val) return;
  const stateDoc = doc(db,"appState","state");
  const snap = await getDoc(stateDoc);
  let data = snap.exists()? snap.data() : { admins: ["admin"], user: "user" };
  data.user = val;
  await setDoc(stateDoc, data);
};
</script>
</body>
</html>
